# GitHub Repository Analysis Tool

This tool uses Claude Code's MCP capabilities to automatically analyze GitHub repositories, generate documentation, and create visual diagrams of code architecture.

## Features

- **Repository Analysis**: Clone and analyze GitHub repositories
- **Code Structure Mapping**: Generate maps of code organization and relationships
- **Critical File Identification**: Highlight the most important files in the repository
- **Diagram Generation**: Create component, sequence, and class diagrams
- **Documentation Creation**: Generate comprehensive markdown documentation
- **Multiple Analysis Profiles**: Create targeted documentation for different audiences

## Output Examples

You can find sample outputs generated by this tool in the `examples/` directory of this repository. These examples include generated documentation and diagrams to help you understand what to expect from running the tool.

## Recent Updates

- **Analysis Profiles**: Generate different documentation for different audiences (developers, architects, operations, etc.) from the same repository
- **Confluence Integration**: Now supports automatic upload of documentation and diagrams to Atlassian Confluence spaces using the Conduit MCP server

## Setup

1. Clone this repository:
   ```bash
   git clone https://github.com/your-username/gh-repo-code-intelligence.git
   cd gh-repo-code-intelligence
   ```

2. Configure Claude permissions by copying the settings template:
   ```bash
   cp .claude/settings.local.json.template .claude/settings.local.json
   ```
   This file contains the necessary permissions for Claude to use all required tools.

3. Configure MCP tools by copying the provided template:
   ```bash
   cp .mcp.json.template ~/.claude/.mcp.json
   ```
   Edit the file to make any necessary adjustments as indicated in the template comments.
   
   **For Confluence integration**: You'll need to install and configure the Conduit MCP server. This is a separate MCP tool that provides Atlassian integration capabilities. See the setup instructions below.

4. Create a `config.json` file based on the template:
   ```bash
   cp config.json.template config.json
   ```

5. Edit `config.json` to include the repositories you want to analyze:
   ```json
   {
     "repos": [
       {
         "name": "organization/repository-name",
         "github_url": "https://github.com/organization/repository-name"
       }
     ],
     "preferred_diagrams": ["component", "sequence", "class"],
     "doc_format": "markdown",
     "analysis_options": {
       "critical_files_limit": 50,
       "include_metrics": true,
       "max_tokens": 5000,
       "analysis_profile": "standard"
     },
     "confluence": {
       "enabled": false,
       "site_alias": "your-site-alias",  // Must match a site in Conduit's config.yaml
       "space_key": "YOUR_SPACE",
       "parent_page_title": "Parent Page Title",
       "page_suffix": ""
     }
   }
   ```

   ### Confluence Integration (Optional)
   
   To enable automatic upload of documentation to Confluence:
   
   1. Set `confluence.enabled` to `true`
   2. Configure your Atlassian site alias, space key, and parent page
   3. Ensure the Conduit MCP server is configured in `.mcp.json` with proper authentication
   
   When enabled, the tool will upload generated documentation and diagrams as Confluence pages.

   > **IMPORTANT**: Always use HTTPS URLs (`https://github.com/...`) for repositories, not SSH URLs (`git@github.com:...`). 
   > SSH URLs will prompt for SSH key passphrase, which breaks automation. However, if you do provide a URL that starts with git@github.com:..., Claude Code will attempt to convert that to https://github.com/... and use that for clone operations.

## Analysis Profiles

The tool supports different analysis profiles to create targeted documentation for specific audiences. You can run the tool multiple times on the same repository with different profiles to generate documentation tailored to different needs.

### Available Profiles

1. **`standard`** (default)
   - General-purpose technical documentation
   - Balanced coverage of architecture, code, and functionality
   - Output: ~15-20 pages

2. **`developer_onboarding`**
   - For new developers joining the project
   - Focuses on: technology stack, development setup, code organization, design patterns
   - Output: ~25-30 pages

3. **`architecture_review`**
   - For architects and technical leads
   - Emphasizes: system design, architectural decisions, patterns, scalability
   - Output: ~25-30 pages

4. **`business_understanding`**
   - For product managers and business stakeholders
   - Highlights: business capabilities, domain concepts, workflows
   - Output: ~20-25 pages

5. **`operations_handover`**
   - For DevOps and operations teams
   - Covers: deployment, configuration, monitoring, dependencies
   - Output: ~20-25 pages

### Configuring Analysis Profiles

To use a specific analysis profile, update your `config.json`:

```json
{
  "analysis_options": {
    "analysis_profile": "developer_onboarding"
  },
  "confluence": {
    "page_suffix": " - Developer Guide"
  }
}
```

The `page_suffix` is optional but recommended when using multiple profiles to distinguish between different versions of documentation for the same repository.

### Example: Creating Multiple Documentation Types

To create both developer and architecture documentation for the same repository:

1. First run with developer profile:
   ```json
   {
     "analysis_options": {
       "analysis_profile": "developer_onboarding"
     },
     "confluence": {
       "page_suffix": " - Developer Guide"
     }
   }
   ```

2. Then run with architecture profile:
   ```json
   {
     "analysis_options": {
       "analysis_profile": "architecture_review"
     },
     "confluence": {
       "page_suffix": " - Architecture Review"
     }
   }
   ```

This will create two separate Confluence pages (if enabled) with different documentation perspectives for the same repository.

## Usage

Run the tool using Claude Code:

```bash
cd /path/to/gh-repo-code-intelligence
claude -p "Analyze repositories according to CLAUDE.md" --dangerously-skip-permissions
```

### Recommended Execution Methods

For automated or scheduled runs, use one of these approaches to avoid terminal hanging issues:

1. **Simple output redirection** (recommended for automation):
   ```bash
   claude -p "Analyze repositories according to CLAUDE.md" --dangerously-skip-permissions --verbose --output-format stream-json > output.json
   ```

2. **Unbuffered output with real-time viewing**:
   ```bash
   claude -p "Analyze repositories according to CLAUDE.md" --dangerously-skip-permissions --verbose --output-format stream-json | stdbuf -o0 tee output.json
   ```

3. **Non-interactive mode for scripts**:
   ```bash
   claude -p "Analyze repositories according to CLAUDE.md" --dangerously-skip-permissions --verbose --output-format stream-json --no-interactive > output.json 2>&1
   ```

**Note**: The `--dangerously-skip-permissions` flag is required for this tool to function properly, as it needs to spawn sub-agents that process repositories in parallel.

**Note**: When using `tee` without unbuffering, the terminal may appear to hang even after completion. This is just buffering behavior - the analysis is complete. Press Ctrl+C to exit.

### What the Tool Does

1. Read repositories from your `config.json`
2. Create or update `state.json` to track progress
3. Clone or refresh each repository 
4. Analyze the repository structure
5. Generate diagrams based on the code analysis
6. Create comprehensive documentation with embedded diagrams
7. Store all outputs in the `output/` directory with timestamped folders
8. (Optional) Upload documentation and diagrams to Confluence if enabled

## Output Structure

```
output/
└── {repo_name}/
    └── {timestamp}/
        ├── docs.md        <- Generated documentation
        └── diagrams/      <- Generated diagrams
            ├── component_diagram.png
            ├── sequence_diagram.png
            └── class_diagram.png
```

## Debugging

For troubleshooting or detailed analysis of the tool's operation, use verbose mode with JSON output:

```bash
claude -p "Analyze repositories according to CLAUDE.md" --dangerously-skip-permissions --verbose --output-format stream-json | tee output.json
```

This will:
- Show detailed progress and debugging information
- Output structured JSON data for each step
- Save all output to `output.json` for later analysis
- Allow real-time monitoring of the analysis process

## Requirements

- Claude Code CLI
- MCP tools access:
  - code-understanding (required)
  - mermaid_image_generator (required)
  - Conduit (required for Confluence integration)

## MCP Tool Setup

This project depends on three MCP tools:

### Required MCP Tools

1. **Code Understanding MCP Tool** (Required for repository analysis)
   - [GitHub Repository](https://github.com/codingthefuturewithai/mcp-code-understanding.git)  
   - [PyPI Package](https://pypi.org/project/code-understanding-mcp-server/)
   - Provides repository cloning, analysis, and code structure mapping

2. **Mermaid Image Generator MCP Tool** (Required for diagram generation)
   - [GitHub Repository](https://github.com/codingthefuturewithai/mcp_mermaid_image_gen.git)  
   - [PyPI Package](https://pypi.org/project/mcp-mermaid-image-gen/)
   - Creates visual diagrams from code analysis

3. **Conduit MCP Tool** (Required for Confluence integration)
   - [GitHub Repository](https://github.com/atlassian-labs/mcp-server-conduit)
   - Provides Atlassian Confluence and Jira integration
   - Required only if you enable Confluence upload in config.json

For setup and configuration instructions, see the documentation in each repository above.  
You will need to add the appropriate entries to your Claude MCP configuration file so Claude Code can use these tools.

### MCP Configuration

This repository includes a `.mcp.json.template` file that contains the configuration for the required MCP tools. Copy this file to `~/.claude/.mcp.json` and edit it as needed to ensure Claude Code can access the MCP tools properly.

### Conduit MCP Setup for Confluence

To enable Confluence integration, you must set up the Conduit MCP server:

1. **Install Conduit**:
   ```bash
   npm install -g @atlassian-labs/mcp-server-conduit
   ```

2. **Configure Conduit**:
   Conduit uses a separate config file for site management. After installation, it will create:
   - macOS/Linux: `~/.config/conduit/config.yaml`
   - Windows: `%APPDATA%\conduit\config.yaml`
   
   Add this to your MCP configuration (`~/.claude/.mcp.json`):
   ```json
   {
     "Conduit": {
       "command": "mcp-server-conduit",
       "args": []
     }
   }
   ```
   
   Note: Conduit manages credentials in its own config.yaml file, not in the MCP configuration.

3. **Set up Conduit Sites**:
   - Create an Atlassian API Token at: https://id.atlassian.com/manage-profile/security/api-tokens
   - Edit Conduit's config.yaml to add your site:
   ```yaml
   confluence:
     sites:
       mycompany:  # Your site alias (use this in config.json)
         url: https://mycompany.atlassian.net/
         email: your-email@example.com
         api_token: your-api-token-here
   ```

4. **Configure your config.json**:
   The `site_alias` must match a site configured in Conduit. First, check your existing Conduit sites:
   ```bash
   # Location varies by OS:
   # macOS/Linux: ~/.config/conduit/config.yaml
   # Windows: %APPDATA%\conduit\config.yaml
   cat ~/.config/conduit/config.yaml
   ```
   
   Look for the `confluence.sites` section to find your available site aliases:
   ```yaml
   confluence:
     sites:
       mycompany:  # <-- This is your site_alias
         url: https://mycompany.atlassian.net/
         email: you@company.com
         api_token: your-token-here
   ```
   
   Then use that site alias in your config.json:
   ```json
   {
     "confluence": {
       "enabled": true,
       "site_alias": "mycompany",  // Must match a site in Conduit config
       "space_key": "YOUR_SPACE",
       "parent_page_title": "Parent Page Title"
     }
   }
   ```
   
   If you need to add a new site to Conduit, edit the config.yaml and add your site under `confluence.sites`.

Without the Conduit MCP server properly configured, Confluence upload functionality will not work.

### GitHub Authentication

For the code-understanding MCP tool to clone repositories:

1. **Public repositories**: No authentication required, but rate limits apply
   
2. **Private repositories**: Requires a GitHub Personal Access Token:
   ```json
   "code-understanding": {
     "command": "code-understanding-mcp-server",
     "args": [
       "--cache-dir", "/path/to/cache-dir",
       "--max-cached-repos", "20"
     ],
     "env": {
       "GITHUB_TOKEN": "your-personal-access-token"
     }
   }
   ```

3. **URL format**: Regardless of repository visibility:
   - **Always use HTTPS URLs** in your config.json, not SSH URLs
   - SSH URLs will prompt for SSH key passphrase, breaking automation
   - Example: use `https://github.com/organization/repo-name.git` instead of `git@github.com:organization/repo-name.git`

## Configuration Options

See `config.json.template` for the full configuration options. Key settings include:

- `repos`: List of repositories to analyze
- `preferred_diagrams`: Types of diagrams to generate
- `analysis_options`: Settings for code analysis depth and detail
  - `analysis_profile`: Choose from `standard`, `developer_onboarding`, `architecture_review`, `business_understanding`, or `operations_handover`
- `confluence.page_suffix`: Optional suffix to distinguish between different profile outputs for the same repository

## Future Enhancements

We're actively working on enhancing this tool with more features:

- **Confluence Integration**: Automatically publish documentation to Atlassian Confluence spaces
- **Documentation Templates**: Customizable templates for different types of documentation
- **Enhanced Diagram Types**: Additional diagram formats for more comprehensive visualization
- **Automated Scheduling**: Integrated scheduling for regular repository analysis updates

## License

MIT